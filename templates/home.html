{% extends 'base.html' %}
{% include 'components/_sidebar.html' %}
{% block title %}Cassino Diamante | Painel{% endblock %}
{% load static %}
{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
<div class="bg-cassino"></div>
<div class="bg-overlay"></div>

<div class="main-content">
    {% include 'components/_sidebar.html' %}

    <!-- Main Content -->
    <div class="content-wrapper">
        <!-- Bot√£o mobile para abrir sidebar -->
        <button id="mobileSidebarBtn" class="lg:hidden fixed top-4 left-4 z-50 w-12 h-12 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white font-bold text-xl rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex items-center justify-center">
            D
        </button>
        
        <header class="main-header">
            <h1 class="main-title">Cassino Diamante</h1>
            <p class="main-subtitle">Sistema de Controle e Gest√£o</p>
        </header>

        <div class="cards-container">
            <!-- Cards de m√©tricas -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white/95 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-red-500/10 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-red-600 to-red-400 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="text-2xl font-black text-red-600 mb-2" data-count="25000">R$ 0</div>
                    <div class="text-sm text-gray-600 font-semibold mb-2">Receita Total</div>
                    <div class="text-xs font-medium text-green-600">+12% desde ontem</div>
                </div>
                <div class="bg-white/95 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-red-500/10 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-red-600 to-red-400 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="text-2xl font-black text-red-600 mb-2" data-count="10">0</div>
                    <div class="text-sm text-gray-600 font-semibold mb-2">Jogadores Ativos</div>
                    <div class="text-xs font-medium text-green-600">+3 na √∫ltima hora</div>
                </div>
                <div class="bg-white/95 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-red-500/10 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-red-600 to-red-400 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="text-2xl font-black text-red-600 mb-2" data-count="2">0</div>
                    <div class="text-sm text-gray-600 font-semibold mb-2">Mesas Ativas</div>
                    <div class="text-xs font-medium text-red-600">de 4 mesas no total</div>
                </div>
                <div class="bg-white/95 backdrop-blur-xl rounded-2xl p-6 shadow-xl border border-red-500/10 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-red-600 to-red-400 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="text-2xl font-black text-red-600 mb-2" data-count="87000">R$ 0</div>
                    <div class="text-sm text-gray-600 font-semibold mb-2">Fichas Vendidas</div>
                    <div class="text-xs font-medium text-gray-600">Estoque restante: R$ 93.000</div>
                </div>
            </div>

            <!-- Mesas de Jogos -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-6 gap-4">
                {% if mesas %}
                    {% for mesa in mesas %}
                    <div class="bg-white/95 backdrop-blur-xl rounded-lg p-4 shadow-xl border border-red-500/10 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative overflow-hidden group min-h-[70px]">
                        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-red-600 to-red-400 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-xs font-bold text-gray-800">{{ mesa.get_tipo_jogo_display }} {{ mesa.numero_mesa }}</div>
                            <div class="px-2 py-1 rounded text-xs font-bold uppercase
                                {% if mesa.status == 'aberta' %}bg-green-100 text-green-800
                                {% elif mesa.status == 'fechada' %}bg-red-100 text-red-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ mesa.get_status_display|upper }}
                            </div>
                        </div>
                        
                        <div class="text-xs text-red-600 font-semibold mb-2">{{ mesa.tipo_jogo|title }}</div>
                        
                        <div class="space-y-1 mb-2">
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-600">Receita:</span>
                                <span class="font-bold text-green-600">R$ {{ mesa.valor_total|floatformat:0 }}</span>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-600">Jogadores:</span>
                                <span>{% if mesa.status == 'aberta' %}4{% elif mesa.status == 'fechada' %}0{% else %}0{% endif %}</span>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-600">Fichas Vendidas:</span>
                            </div>
                        </div>
                        
                        <div class="w-full h-1 bg-gray-200 rounded-full mb-2 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-amber-500 to-amber-400 rounded-full transition-all duration-300" 
                                 style="width: {% if mesa.status == 'aberta' %}75{% elif mesa.status == 'fechada' %}100{% else %}0{% endif %}%"></div>
                        </div>
                        
                        <div class="text-xs text-gray-400 mb-3">
                            {% if mesa.status == 'aberta' %}5 minutos atr√°s
                            {% elif mesa.status == 'fechada' %}1 hora atr√°s
                            {% else %}3 horas atr√°s{% endif %}
                        </div>
                        
                        {% if mesa.status == 'aberta' %}
                            <button class="w-full py-2 px-3 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white text-xs font-bold rounded-md shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 uppercase" 
                                    onclick="fecharMesa({{ mesa.id }})">
                                Fechar Mesa
                            </button>
                        {% else %}
                            <button class="w-full py-2 px-3 bg-gradient-to-r from-amber-500 to-amber-400 hover:from-amber-600 hover:to-amber-500 text-white text-xs font-bold rounded-md shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 uppercase" 
                                    onclick="abrirMesa({{ mesa.id }})">
                                Abrir Mesa
                            </button>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-span-full bg-white/95 backdrop-blur-xl rounded-2xl p-8 shadow-xl border border-red-500/10 text-center">
                        <div class="text-4xl mb-4">üé∞</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Nenhuma Mesa Criada</h3>
                        <p class="text-gray-600 mb-6">N√£o h√° mesas no sistema ainda.</p>
                        <button class="bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300" 
                                onclick="abrirModalCriarMesa()">
                            Criar Primeira Mesa
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    const sidebar = document.getElementById('sidebar');
    const logoClickable = document.getElementById('logoClickable');

    // Fun√ß√£o para verificar se √© mobile
    const isMobile = () => window.innerWidth <= 1024;

    // Fun√ß√£o para abrir sidebar
    function openSidebar() {
        if (isMobile()) {
            sidebar.classList.add('mobile-open');
            sidebar.classList.remove('closed');
        } else {
            sidebar.classList.remove('closed');
        }
    }

    // Fun√ß√£o para fechar sidebar
    function closeSidebar() {
        if (isMobile()) {
            sidebar.classList.remove('mobile-open');
        } else {
            sidebar.classList.add('closed');
        }
    }

    // Toggle sidebar
    function toggleSidebar() {
        if (sidebar.classList.contains('closed')) {
            openSidebar();
        } else {
            closeSidebar();
        }
    }

    // Event listener para clicar no logo
    logoClickable.addEventListener('click', toggleSidebar);

    // Event listener para o bot√£o mobile
    const mobileSidebarBtn = document.getElementById('mobileSidebarBtn');
    if (mobileSidebarBtn) {
        mobileSidebarBtn.addEventListener('click', () => {
            if (isMobile()) {
                openSidebar();
            }
        });
    }

    // Fechar sidebar no mobile ao clicar fora
    document.addEventListener('click', (e) => {
        if (isMobile() && !sidebar.contains(e.target) && !mobileSidebarBtn.contains(e.target)) {
            closeSidebar();
        }
    });

    // Animar contadores
    function animateCounter(element) {
        const target = parseInt(element.getAttribute('data-count'));
        const duration = 2000;
        const step = target / (duration / 16);
        let current = 0;

        const timer = setInterval(() => {
            current += step;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            
            if (element.textContent.includes('R$')) {
                element.textContent = 'R$ ' + Math.floor(current).toLocaleString();
            } else {
                element.textContent = Math.floor(current).toLocaleString();
            }
        }, 16);
    }

    // Observer para animar contadores quando os cards entram na tela
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const counters = entry.target.querySelectorAll('[data-count]');
                counters.forEach((counter, index) => {
                    setTimeout(() => {
                        animateCounter(counter);
                    }, index * 200);
                });
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.3 });

    // Observar cards de m√©tricas (agora usando classes Tailwind)
    const metricCards = document.querySelectorAll('.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 > div');
    metricCards.forEach(card => {
        observer.observe(card);
    });

    // Fun√ß√£o para fechar mesa
    function fecharMesa(mesaId) {
        if (confirm('Tem certeza que deseja fechar esta mesa?')) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/mesas/api/fechar/${mesaId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao fechar mesa. Tente novamente.');
            });
        }
    }

    // Fun√ß√£o para abrir mesa
    function abrirMesa(mesaId) {
        if (confirm('Tem certeza que deseja abrir esta mesa?')) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/mesas/api/abrir/${mesaId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao abrir mesa. Tente novamente.');
            });
        }
    }

    // Fun√ß√£o para abrir modal de criar mesa
    function abrirModalCriarMesa() {
        alert('Funcionalidade de criar mesa ser√° implementada em breve!');
    }

    // Inicializar sidebar fechada no desktop
    if (!isMobile()) {
        sidebar.classList.add('closed');
    }
</script>
{% endblock %} 