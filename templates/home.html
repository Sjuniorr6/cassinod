{% extends 'base.html' %}
{% include 'components/_sidebar.html' %}
{% block title %}Cassino Diamante | Painel{% endblock %}
{% load static %}
{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
<div class="bg-cassino"></div>
<div class="bg-overlay"></div>

<div class="main-content">
    {% include 'components/_sidebar.html' %}

    <!-- Main Content -->
    <div class="content-wrapper">
        <header class="main-header">
            <h1 class="main-title">Cassino Diamante</h1>
            <p class="main-subtitle">Sistema de Controle e Gest√£o</p>
        </header>

        <div class="cards-container">
            <!-- Cards de m√©tricas -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" data-count="25000">R$ 0</div>
                    <div class="metric-label">Receita Total</div>
                    <div class="metric-change positive">+12% desde ontem</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" data-count="10">0</div>
                    <div class="metric-label">Jogadores Ativos</div>
                    <div class="metric-change positive">+3 na √∫ltima hora</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" data-count="2">0</div>
                    <div class="metric-label">Mesas Ativas</div>
                    <div class="metric-change negative">de 4 mesas no total</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" data-count="87000">R$ 0</div>
                    <div class="metric-label">Fichas Vendidas</div>
                    <div class="metric-change neutral">Estoque restante: R$ 93.000</div>
                </div>
            </div>

            <!-- Mesas de Jogos -->
            <div class="tables-grid">
                {% if mesas %}
                    {% for mesa in mesas %}
                    <div class="table-card">
                        <div class="table-header">
                            <div class="table-name">{{ mesa.get_tipo_jogo_display }} {{ mesa.numero_mesa }}</div>
                            <div class="table-status 
                                {% if mesa.status == 'aberta' %}status-open
                                {% elif mesa.status == 'fechada' %}status-closed
                                {% else %}status-maintenance{% endif %}">
                                {{ mesa.get_status_display|upper }}
                            </div>
                        </div>
                        <div class="table-type">{{ mesa.tipo_jogo|title }}</div>
                        <div class="table-stats">
                            <div class="table-stat">
                                <span>Receita:</span>
                                <span class="stat-value">R$ {{ mesa.valor_total|floatformat:0 }}</span>
                            </div>
                            <div class="table-stat">
                                <span>Jogadores:</span>
                                <span>{% if mesa.status == 'aberta' %}4{% elif mesa.status == 'fechada' %}0{% else %}0{% endif %}</span>
                            </div>
                            <div class="table-stat">
                                <span>Fichas Vendidas:</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {% if mesa.status == 'aberta' %}75{% elif mesa.status == 'fechada' %}100{% else %}0{% endif %}%"></div>
                        </div>
                        <div class="table-last-update">
                            {% if mesa.status == 'aberta' %}5 minutos atr√°s
                            {% elif mesa.status == 'fechada' %}1 hora atr√°s
                            {% else %}3 horas atr√°s{% endif %}
                        </div>
                        {% if mesa.status == 'aberta' %}
                            <button class="table-button" onclick="fecharMesa({{ mesa.id }})">Fechar Mesa</button>
                        {% else %}
                            <button class="table-button secondary" onclick="abrirMesa({{ mesa.id }})">Abrir Mesa</button>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="table-card empty-state">
                        <div class="empty-icon">üé∞</div>
                        <h3>Nenhuma Mesa Criada</h3>
                        <p>N√£o h√° mesas no sistema ainda.</p>
                        <button class="table-button" onclick="abrirModalCriarMesa()">Criar Primeira Mesa</button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    const sidebar = document.getElementById('sidebar');
    const logoClickable = document.getElementById('logoClickable');

    // Fun√ß√£o para verificar se √© mobile
    const isMobile = () => window.innerWidth <= 1024;

    // Fun√ß√£o para abrir sidebar
    function openSidebar() {
        if (isMobile()) {
            sidebar.classList.add('mobile-open');
            sidebar.classList.remove('closed');
        } else {
            sidebar.classList.remove('closed');
        }
    }

    // Fun√ß√£o para fechar sidebar
    function closeSidebar() {
        if (isMobile()) {
            sidebar.classList.remove('mobile-open');
        } else {
            sidebar.classList.add('closed');
        }
    }

    // Toggle sidebar
    function toggleSidebar() {
        if (sidebar.classList.contains('closed')) {
            openSidebar();
        } else {
            closeSidebar();
        }
    }

    // Event listener para clicar no logo
    logoClickable.addEventListener('click', toggleSidebar);

    // Fechar sidebar no mobile ao clicar fora
    document.addEventListener('click', (e) => {
        if (isMobile() && !sidebar.contains(e.target)) {
            closeSidebar();
        }
    });

    // Animar contadores
    function animateCounter(element) {
        const target = parseInt(element.getAttribute('data-count'));
        const duration = 2000;
        const step = target / (duration / 16);
        let current = 0;

        const timer = setInterval(() => {
            current += step;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            
            if (element.textContent.includes('R$')) {
                element.textContent = 'R$ ' + Math.floor(current).toLocaleString();
            } else {
                element.textContent = Math.floor(current).toLocaleString();
            }
        }, 16);
    }

    // Observer para animar contadores quando os cards entram na tela
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const counters = entry.target.querySelectorAll('[data-count]');
                counters.forEach((counter, index) => {
                    setTimeout(() => {
                        animateCounter(counter);
                    }, index * 200);
                });
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.3 });

    // Observar cards de m√©tricas
    const metricCards = document.querySelectorAll('.metric-card');
    metricCards.forEach(card => {
        observer.observe(card);
    });

    // Fun√ß√£o para fechar mesa
    function fecharMesa(mesaId) {
        if (confirm('Tem certeza que deseja fechar esta mesa?')) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/mesas/api/fechar/${mesaId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao fechar mesa. Tente novamente.');
            });
        }
    }

    // Fun√ß√£o para abrir mesa
    function abrirMesa(mesaId) {
        if (confirm('Tem certeza que deseja abrir esta mesa?')) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/mesas/api/abrir/${mesaId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao abrir mesa. Tente novamente.');
            });
        }
    }

    // Fun√ß√£o para abrir modal de criar mesa
    function abrirModalCriarMesa() {
        alert('Funcionalidade de criar mesa ser√° implementada em breve!');
    }

    // Inicializar sidebar fechada no desktop
    if (!isMobile()) {
        sidebar.classList.add('closed');
    }
</script>
{% endblock %} 